import React, { useState, useEffect } from 'react';
import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  Box,
  Typography,
  Chip,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  TextField,
  MenuItem,
  Select,
  FormControl,
  InputLabel,
  CircularProgress,
  Alert,
  IconButton,
  Collapse,
  Link,
} from '@mui/material';
import { ChevronDown, ChevronUp, Download } from 'lucide-react';
import { securityScanService } from '../../security/services/securityScanService';
import { getAPIBaseURL } from '../../../constants/apiConfig';

const API_BASE_URL =
  process.env.SECURESTOR_APP_API_URL || getAPIBaseURL() + "/api/v1";

const VulnerabilityReportModal = ({ open, onClose, scanId, artifactName }) => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [scanData, setScanData] = useState(null);
  const [vulnerabilities, setVulnerabilities] = useState([]);
  const [filteredVulnerabilities, setFilteredVulnerabilities] = useState([]);
  const [expandedRow, setExpandedRow] = useState(null);
  
  // Filter states
  const [severityFilter, setSeverityFilter] = useState('all');
  const [searchFilter, setSearchFilter] = useState('');

  useEffect(() => {
    if (open && scanId) {
      fetchScanDetails();
    }
  }, [open, scanId]);

  useEffect(() => {
    applyFilters();
  }, [vulnerabilities, severityFilter, searchFilter]);

  const fetchScanDetails = async () => {
    setLoading(true);
    setError(null);
    try {
      const data = await securityScanService.getScanDetails(scanId);
      setScanData(data);
      
      if (data.results && data.results.vulnerability_results && data.results.vulnerability_results.vulnerabilities) {
        setVulnerabilities(data.results.vulnerability_results.vulnerabilities);
      } else {
        setVulnerabilities([]);
      }
    } catch (err) {
      console.error('Error fetching scan details:', err);
      setError('Failed to load vulnerability details. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  const applyFilters = () => {
    let filtered = [...vulnerabilities];

    // Apply severity filter
    if (severityFilter !== 'all') {
      filtered = filtered.filter(v => v.severity === severityFilter.toUpperCase());
    }

    // Apply search filter
    if (searchFilter) {
      const searchLower = searchFilter.toLowerCase();
      filtered = filtered.filter(v => 
        v.id?.toLowerCase().includes(searchLower) ||
        v.cve?.toLowerCase().includes(searchLower) ||
        v.title?.toLowerCase().includes(searchLower) ||
        v.component?.toLowerCase().includes(searchLower) ||
        v.description?.toLowerCase().includes(searchLower)
      );
    }

    setFilteredVulnerabilities(filtered);
  };

  const getSeverityColor = (severity) => {
    switch (severity?.toUpperCase()) {
      case 'CRITICAL':
        return '#d32f2f';
      case 'HIGH':
        return '#f57c00';
      case 'MEDIUM':
        return '#fbc02d';
      case 'LOW':
        return '#388e3c';
      default:
        return '#757575';
    }
  };

  const handleExport = () => {
    if (!scanData) return;

    const exportData = {
      artifact: artifactName,
      scan_id: scanId,
      scan_date: scanData.created_at,
      summary: {
        total: scanData.results?.vulnerability_results?.total_found || 0,
        critical: scanData.results?.vulnerability_results?.critical || 0,
        high: scanData.results?.vulnerability_results?.high || 0,
        medium: scanData.results?.vulnerability_results?.medium || 0,
        low: scanData.results?.vulnerability_results?.low || 0,
      },
      vulnerabilities: filteredVulnerabilities,
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `vulnerability-report-${scanId}-${Date.now()}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  const toggleRow = (vulnId) => {
    setExpandedRow(expandedRow === vulnId ? null : vulnId);
  };

  return (
    <Dialog 
      open={open} 
      onClose={onClose} 
      maxWidth="lg" 
      fullWidth
      PaperProps={{
        sx: { height: '90vh' }
      }}
    >
      <DialogTitle>
        <Box display="flex" justifyContent="space-between" alignItems="center">
          <Typography variant="h6">
            Vulnerability Report - {artifactName}
          </Typography>
          <IconButton onClick={handleExport} disabled={loading || !scanData}>
            <Download className="w-5 h-5" />
          </IconButton>
        </Box>
      </DialogTitle>

      <DialogContent dividers>
        {loading && (
          <Box display="flex" justifyContent="center" alignItems="center" minHeight="400px">
            <CircularProgress />
          </Box>
        )}

        {error && (
          <Alert severity="error" sx={{ mb: 2 }}>
            {error}
          </Alert>
        )}

        {!loading && scanData && (
          <>
            {/* Summary Section */}
            <Box sx={{ mb: 3, p: 2, bgcolor: 'background.default', borderRadius: 1 }}>
              <Typography variant="subtitle1" gutterBottom fontWeight="bold">
                Summary
              </Typography>
              <Box display="flex" gap={2} flexWrap="wrap">
                <Chip 
                  label={`Total: ${scanData.results?.vulnerability_results?.total_found || 0}`}
                  sx={{ fontWeight: 'bold' }}
                />
                <Chip 
                  label={`Critical: ${scanData.results?.vulnerability_results?.critical || 0}`}
                  sx={{ bgcolor: getSeverityColor('CRITICAL'), color: 'white' }}
                />
                <Chip 
                  label={`High: ${scanData.results?.vulnerability_results?.high || 0}`}
                  sx={{ bgcolor: getSeverityColor('HIGH'), color: 'white' }}
                />
                <Chip 
                  label={`Medium: ${scanData.results?.vulnerability_results?.medium || 0}`}
                  sx={{ bgcolor: getSeverityColor('MEDIUM'), color: 'white' }}
                />
                <Chip 
                  label={`Low: ${scanData.results?.vulnerability_results?.low || 0}`}
                  sx={{ bgcolor: getSeverityColor('LOW'), color: 'white' }}
                />
              </Box>
              <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
                Scan Date: {new Date(scanData.created_at).toLocaleString()}
              </Typography>
            </Box>

            {/* Filters Section */}
            <Box sx={{ mb: 2, display: 'flex', gap: 2, flexWrap: 'wrap' }}>
              <TextField
                label="Search (CVE, Component, Description)"
                variant="outlined"
                size="small"
                value={searchFilter}
                onChange={(e) => setSearchFilter(e.target.value)}
                sx={{ flexGrow: 1, minWidth: 300 }}
              />
              <FormControl size="small" sx={{ minWidth: 150 }}>
                <InputLabel>Severity</InputLabel>
                <Select
                  value={severityFilter}
                  label="Severity"
                  onChange={(e) => setSeverityFilter(e.target.value)}
                >
                  <MenuItem value="all">All</MenuItem>
                  <MenuItem value="critical">Critical</MenuItem>
                  <MenuItem value="high">High</MenuItem>
                  <MenuItem value="medium">Medium</MenuItem>
                  <MenuItem value="low">Low</MenuItem>
                </Select>
              </FormControl>
            </Box>

            {/* Vulnerabilities Table */}
            <TableContainer component={Paper} sx={{ maxHeight: 'calc(90vh - 400px)' }}>
              <Table stickyHeader size="small">
                <TableHead>
                  <TableRow>
                    <TableCell width="5%"></TableCell>
                    <TableCell width="15%">CVE ID</TableCell>
                    <TableCell width="10%">Severity</TableCell>
                    <TableCell width="20%">Component</TableCell>
                    <TableCell width="10%">Version</TableCell>
                    <TableCell width="10%">Fixed In</TableCell>
                    <TableCell width="30%">Description</TableCell>
                  </TableRow>
                </TableHead>
                <TableBody>
                  {filteredVulnerabilities.length === 0 ? (
                    <TableRow>
                      <TableCell colSpan={7} align="center">
                        <Typography color="text.secondary" py={3}>
                          No vulnerabilities found matching the filters
                        </Typography>
                      </TableCell>
                    </TableRow>
                  ) : (
                    filteredVulnerabilities.map((vuln, index) => {
                      const uniqueKey = `${vuln.id || 'vuln'}-${vuln.component || 'unknown'}-${index}`;
                      return (
                        <React.Fragment key={uniqueKey}>
                          <TableRow 
                            hover 
                            onClick={() => toggleRow(uniqueKey)}
                            sx={{ cursor: 'pointer', '& > *': { borderBottom: 'unset' } }}
                          >
                          <TableCell>
                            <IconButton size="small">
                              {expandedRow === uniqueKey ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
                            </IconButton>
                          </TableCell>
                          <TableCell>
                            <Typography variant="body2" fontWeight="medium">
                              {vuln.cve || vuln.id}
                            </Typography>
                            {vuln.cve && vuln.cve !== vuln.id && (
                              <Typography variant="caption" color="text.secondary" display="block">
                                {vuln.id}
                              </Typography>
                            )}
                          </TableCell>
                          <TableCell>
                            <Chip 
                              label={vuln.severity}
                              size="small"
                              sx={{ 
                                bgcolor: getSeverityColor(vuln.severity),
                                color: 'white',
                                fontWeight: 'bold',
                              }}
                            />
                          </TableCell>
                          <TableCell>{vuln.component}</TableCell>
                          <TableCell>{vuln.version}</TableCell>
                          <TableCell>{vuln.fixed_version || 'N/A'}</TableCell>
                          <TableCell>
                            <Typography 
                              variant="body2" 
                              sx={{
                                overflow: 'hidden',
                                textOverflow: 'ellipsis',
                                display: '-webkit-box',
                                WebkitLineClamp: 2,
                                WebkitBoxOrient: 'vertical',
                              }}
                            >
                              {vuln.description}
                            </Typography>
                          </TableCell>
                        </TableRow>
                        <TableRow>
                          <TableCell style={{ paddingBottom: 0, paddingTop: 0 }} colSpan={7}>
                            <Collapse in={expandedRow === uniqueKey} timeout="auto" unmountOnExit>
                              <Box sx={{ margin: 2, p: 2, bgcolor: 'background.default', borderRadius: 1 }}>
                                <Typography variant="subtitle2" gutterBottom fontWeight="bold">
                                  Full Description
                                </Typography>
                                <Typography variant="body2" paragraph>
                                  {vuln.description}
                                </Typography>
                                
                                {/* Secret Detection - Special Handling */}
                                {vuln.id && vuln.id.includes('SECRET') && (
                                  <Box sx={{ mb: 2, p: 2, bgcolor: 'info.light', borderRadius: 1, border: '1px solid', borderColor: 'info.main' }}>
                                    <Typography variant="subtitle2" gutterBottom fontWeight="bold" color="info.dark">
                                      üìã Understanding Secret Detections
                                    </Typography>
                                    <Typography variant="body2" paragraph>
                                      This is a potential secret detected by static analysis. <strong>Verified: {vuln.description?.includes('Verified: true') ? 'Yes ‚úì' : 'No (likely false positive)'}</strong>
                                    </Typography>
                                    <Typography variant="subtitle2" gutterBottom fontWeight="bold" color="info.dark">
                                      ‚úÖ Recommended Actions:
                                    </Typography>
                                    <Box component="ul" sx={{ pl: 3, mb: 1 }}>
                                      <li><Typography variant="body2">Review the file and line number mentioned above</Typography></li>
                                      <li><Typography variant="body2">Check if this is an actual secret (API key, password, token) or a false positive (placeholder, example, or config key)</Typography></li>
                                      <li><Typography variant="body2"><strong>If it's a real secret:</strong> Rotate/revoke it immediately and use environment variables or secrets management (AWS Secrets Manager, HashiCorp Vault, etc.)</Typography></li>
                                      <li><Typography variant="body2"><strong>If it's a false positive:</strong> Add it to your scanner's ignore list or use inline comments to suppress the warning</Typography></li>
                                      <li><Typography variant="body2">Never commit real secrets to version control - use .gitignore for sensitive files</Typography></li>
                                    </Box>
                                  </Box>
                                )}

                                {/* Location Information */}
                                {(vuln.file || vuln.line) && (
                                  <>
                                    <Typography variant="subtitle2" gutterBottom fontWeight="bold">
                                      üìç Location
                                    </Typography>
                                    <Box sx={{ mb: 2, p: 1.5, bgcolor: 'grey.50', borderRadius: 1, fontFamily: 'monospace' }}>
                                      {vuln.file && (
                                        <Typography variant="body2">
                                          <strong>File:</strong> {vuln.file}
                                        </Typography>
                                      )}
                                      {vuln.line && vuln.line !== 'Line 0' && vuln.line !== '0' && (
                                        <Typography variant="body2">
                                          <strong>Line:</strong> {vuln.line}
                                        </Typography>
                                      )}
                                    </Box>
                                  </>
                                )}

                                {/* CVE/Vulnerability Details */}
                                {vuln.cve && !vuln.id.includes('SECRET') && (
                                  <>
                                    <Typography variant="subtitle2" gutterBottom fontWeight="bold">
                                      üîç Vulnerability Details
                                    </Typography>
                                    <Box sx={{ mb: 2, p: 2, bgcolor: 'warning.light', borderRadius: 1, border: '1px solid', borderColor: 'warning.main' }}>
                                      <Typography variant="body2" paragraph>
                                        <strong>CVE ID:</strong> {vuln.cve}
                                      </Typography>
                                      {vuln.cvss_score && (
                                        <Typography variant="body2" paragraph>
                                          <strong>CVSS Score:</strong> {vuln.cvss_score} - This indicates the severity of the vulnerability
                                        </Typography>
                                      )}
                                      <Typography variant="subtitle2" gutterBottom fontWeight="bold" color="warning.dark">
                                        ‚úÖ How to Fix:
                                      </Typography>
                                      <Box component="ul" sx={{ pl: 3, mb: 0 }}>
                                        {vuln.fixed_version && vuln.fixed_version !== 'N/A' ? (
                                          <>
                                            <li><Typography variant="body2"><strong>Update {vuln.component} from version {vuln.version} to {vuln.fixed_version}</strong></Typography></li>
                                            <li><Typography variant="body2">Update your dependency file (package.json, pom.xml, requirements.txt, etc.)</Typography></li>
                                            <li><Typography variant="body2">Run your package manager's update command</Typography></li>
                                            <li><Typography variant="body2">Test thoroughly to ensure compatibility</Typography></li>
                                          </>
                                        ) : (
                                          <>
                                            <li><Typography variant="body2">No fix is currently available for this vulnerability</Typography></li>
                                            <li><Typography variant="body2">Consider using an alternative package or implement mitigation controls</Typography></li>
                                            <li><Typography variant="body2">Monitor security advisories for updates</Typography></li>
                                          </>
                                        )}
                                      </Box>
                                    </Box>
                                  </>
                                )}
                                
                                {vuln.cvss_score && vuln.id.includes('SECRET') === false && (
                                  <>
                                    <Typography variant="subtitle2" gutterBottom fontWeight="bold">
                                      CVSS Score
                                    </Typography>
                                    <Typography variant="body2" paragraph>
                                      {vuln.cvss_score}
                                    </Typography>
                                  </>
                                )}

                                {vuln.references && vuln.references.length > 0 && (
                                  <>
                                    <Typography variant="subtitle2" gutterBottom fontWeight="bold">
                                      üìö References & Additional Information
                                    </Typography>
                                    <Box sx={{ pl: 2 }}>
                                      {vuln.references.slice(0, 5).map((ref, idx) => (
                                        <Typography key={idx} variant="body2">
                                          <Link href={ref} target="_blank" rel="noopener noreferrer">
                                            {ref}
                                          </Link>
                                        </Typography>
                                      ))}
                                      {vuln.references.length > 5 && (
                                        <Typography variant="body2" color="text.secondary">
                                          ... and {vuln.references.length - 5} more
                                        </Typography>
                                      )}
                                    </Box>
                                  </>
                                )}
                              </Box>
                            </Collapse>
                          </TableCell>
                        </TableRow>
                      </React.Fragment>
                    );
                    })
                  )}
                </TableBody>
              </Table>
            </TableContainer>

            <Box sx={{ mt: 2, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <Typography variant="body2" color="text.secondary">
                Showing {filteredVulnerabilities.length} of {vulnerabilities.length} vulnerabilities
              </Typography>
            </Box>
          </>
        )}
      </DialogContent>

      <DialogActions>
        <Button onClick={onClose}>Close</Button>
      </DialogActions>
    </Dialog>
  );
};

export default VulnerabilityReportModal;
